<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="Fortnightly Food Prep & Sharing Roster Management">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KC GROW: Food-Share Roster</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FoodShare">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%234f46e5' width='192' height='192' rx='40'/%3E%3Ctext x='96' y='120' font-size='80' text-anchor='middle' fill='white'%3E%F0%9F%8D%BD%3C/text%3E%3C/svg%3E">

    <link rel="stylesheet" href="styles.css">
</head>
<!-- <script>
  // GitHub Pages SPA redirect handling
  (function(){
    var redirect = sessionStorage.redirect;
    delete sessionStorage.redirect;
    if (redirect && redirect != location.href) {
      history.replaceState(null, null, redirect);
    }
  })();
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      registrations.forEach(function(registration) {
        registration.unregister();
      });
    });
    if ('caches' in window) {
      caches.keys().then(function(names) {
        names.forEach(function(name) {
          caches.delete(name);
        });
      });
    }
  }
</script> -->
<body>

    <!-- Turn Notification Banner -->
    <div id="turnBanner" class="notification-banner">
        <span id="turnMessage"></span>
        <button onclick="this.parentElement.classList.remove('show')" style="margin-left: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer;">Dismiss</button>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>KC GROW: Food-Share Roster</h1>
            <div class="header-controls">
                <button class="view-toggle-btn" id="viewToggleBtn" onclick="app.toggleView()">
                    <span id="viewToggleIcon">‚õ™</span>
                    <span id="viewToggleText">Church Info</span>
                </button>
                <button class="user-profile-btn" id="userProfileBtn" onclick="app.openUserProfile()">
                    <span id="userNameDisplay">üë§ Set My Name</span>
                </button>
                <button class="btn btn-icon" onclick="app.regenerateRoster()" title="Regenerate Roster">üîÑ</button>
                <button class="btn" onclick="app.openSettings()">‚öôÔ∏è Members</button>
                <button class="btn btn-primary" onclick="app.addWeek()">+ Add Week</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div id="rosterView" class="view-section active">
        <div class="main-container">
            <!-- Left Panel: Calendar/List View (75%) -->
            <div class="panel" style="grid-column: 1;">
                <div class="panel-header">
                    <div class="panel-title">
                        Weekly Schedule
                        <span id="weekCount" style="font-size: 0.875rem; color: var(--text-light); font-weight: normal;">(0 weeks)</span>
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="app.setView('calendar')">Calendar</button>
                        <button class="view-btn" onclick="app.setView('list')">List</button>
                    </div>
                </div>
                <div class="panel-body" id="scheduleContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No Schedule Yet</h3>
                        <p>Add members and generate your first week to get started</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Statistics (25%) -->
            <div class="panel" style="grid-column: 2;">
                <div class="panel-header">
                    <div class="panel-title">Statistics</div>
                </div>
                <div class="panel-body">
                    <div class="stats-grid" id="statsContainer">
                        <div class="empty-state" style="padding: 1rem;">
                            <p>Add members to see statistics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="churchInfoView" class="view-section">
        <div class="church-info-container">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="welcome-title">WELCOME<br>HOME</div>
                <div class="welcome-subtitle">Praise the Lord, my soul; all my inmost being, praise his holy name. (Psalm 103:1)</div>
            </div>

            <!-- Info Cards Grid -->
            <div class="info-grid">
                <!-- Sunday Service Card -->
                <div class="info-card">
                    <div class="info-card-title coral">Sunday Service</div>
                    
                    <div class="service-item">
                        <div class="service-time">9am</div>
                        <div class="service-name">International Service</div>
                    </div>

                    <div class="service-item">
                        <div class="service-time">9.15am</div>
                        <div class="service-name">ROCK Junior</div>
                    </div>

                    <div class="service-item">
                        <div class="service-time">5pm</div>
                        <div class="service-name">KGC</div>
                    </div>
                </div>

                <!-- Upper Room Card -->
                <div class="info-card">
                    <div class="info-card-title mauve">Upper Room</div>
                    
                    <div class="service-item">
                        <div class="meeting-info">Every Saturday 8am</div>
                    </div>

                    <div class="simple-toggle" onclick="this.classList.toggle('show-text')">
                        <div class="simple-text">
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">Meeting ID: 895 0855 5811</div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--coral-red);">Passcode: RIM-BNE</div>
                            <div class="simple-caption">Tap to see QR code</div>
                        </div>
                            <div class="simple-image">
                                <img src="./assets/image.png" alt="QR Code" style="width: 150px; height: 150px;">
                            <div class="simple-caption">Tap to see details</div>
                        </div>
                    </div>
                </div>

                <!-- Kingdom Communities Card -->
                <div class="info-card">
                    <div class="info-card-title blue">Kingdom Communities</div>
                    
                    <div class="community-info">
                        <div class="community-item">
                            <div class="day-time">Wednesday 6.45pm</div>
                            <div class="location-name">KC BLEASBY</div>
                            <div class="contact-name">Jennifer Gani</div>
                        </div>

                        <div class="community-item">
                            <div class="day-time">Friday 6.30pm</div>
                            <div class="location-name">KC FRIDAY</div>
                            <div class="contact-name">Sanggam Lumbangaol</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Section -->
            <div class="contact-card">
                <h2>Contact Us</h2>
                <div class="contact-details">
                    <p>üìß Email: info@rockchurch.org</p>
                    <p>üìû Phone: +61 XXX XXX XXX</p>
                    <p>üìç Address: Brisbane, Australia</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2026 ROCK GROW-ing Brisbane.</p>
    </footer>
    <!-- Auth Container (shown when not logged in) -->
    <div id="authContainer" style="display: none;">
        <div class="auth-card">
            <h2>‚õ™ FoodShare Roster</h2>
            
            <!-- Login Form -->
            <div id="loginForm">
                <h3>Sign In</h3>
                <input type="email" id="loginEmail" placeholder="Email" class="form-input">
                <input type="password" id="loginPassword" placeholder="Password" class="form-input">
                <button onclick="authApp.login()" class="btn btn-primary">Sign In</button>
                <p>Don't have an account? <a href="#" onclick="authApp.showSignup()">Sign up</a></p>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <h3>Sign Up</h3>
                <input type="text" id="signupName" placeholder="Full Name" class="form-input">
                <input type="text" id="signupUsername" placeholder="Username" class="form-input">
                <input type="email" id="signupEmail" placeholder="Email" class="form-input">
                <input type="password" id="signupPassword" placeholder="Password" class="form-input">
                <button onclick="authApp.signup()" class="btn btn-primary">Create Account</button>
                <p>Already have an account? <a href="#" onclick="authApp.showLogin()">Sign in</a></p>
            </div>
        </div>
    </div>

    <!-- Profile Modal (new) -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ My Profile</div>
                <button class="close-btn" onclick="app.closeProfile()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="profileUsername" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="profileFullName" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea id="profileBio" class="form-input" rows="4" placeholder="Tell us about yourself..."></textarea>
                    <div style="text-align: right; font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                        <span id="bioCharCount">0</span>/500
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="profileEmail" class="form-input" readonly style="background: var(--bg);">
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button class="btn" onclick="app.closeProfile()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="app.saveProfile()" style="flex: 2;">Save Profile</button>
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border);">
                <button class="btn" onclick="authApp.logout()" style="width: 100%; background: var(--danger); color: white;">Log Out</button>
            </div>
        </div>
    </div>
    <div class="modal" id="userProfileModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">üë§ My Profile & Notifications</div>
                <button class="close-btn" onclick="app.closeUserProfile()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="border-bottom: 2px solid var(--border); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <label class="form-label">Who are you?</label>
                    <select class="form-select" id="userNameSelect" onchange="app.handleUserNameChange()">
                        <option value="">-- Select your name --</option>
                    </select>
                    <p style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
                        Don't see your name? Ask the admin to add you in Members settings.
                    </p>
                    <div id="userNamePreview" style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg); border-radius: 0.5rem; display: none;">
                        <strong>Selected:</strong> <span id="selectedNameDisplay" style="color: var(--primary); font-weight: 700;"></span>
                    </div>
                </div>

                <!-- Master Notification Toggle -->
                <div class="form-group">
                    <div class="toggle-switch" style="background: linear-gradient(135deg, var(--bg), #f9fafb); border: 2px solid var(--border);">
                        <div>
                            <div class="toggle-label">Enable Notifications</div>
                            <div class="toggle-description">Get reminded when it's your turn</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notificationMasterToggle" onchange="app.toggleNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p id="notificationStatus" style="font-size: 0.875rem; margin-top: 0.75rem; font-weight: 600;"></p>
                </div>

                <!-- Notification Settings (shown when enabled) -->
                <div id="notificationSettingsPanel" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                    
                    <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--text);">Customize Alerts</h3>
                    
                    <!-- Food Prep Settings -->
                    <div class="notification-type-block" style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-weight: 700; color: #1e40af;">Food Prep</span>
                            <label class="switch" style="transform: scale(0.85);">
                                <input type="checkbox" id="notifyPrepToggle" checked onchange="app.updateNotificationType('prep')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="prepTimingContainer">
                            <label style="font-size: 0.875rem; font-weight: 600; color: #3b82f6; display: block; margin-bottom: 0.5rem;">
                                Remind me:
                            </label>
                            <select class="form-select" id="prepNoticeSelect" onchange="app.updateNoticeTiming('prep')" style="border-color: #3b82f6; background: white;">
                                <option value="10080">1 week before</option>
                                <option value="4320">3 days before</option>
                                <option value="1440" selected>1 day before</option>
                                <option value="720">12 hours before</option>
                                <option value="240">4 hours before</option>
                                <option value="60">1 hour before</option>
                                <option value="30">30 minutes before</option>
                                <option value="15">15 minutes before</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sharing Settings -->
                    <div class="notification-type-block" style="background: #ecfdf5; border: 2px solid #10b981; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-weight: 700; color: #065f46;">Sharing</span>
                            <label class="switch" style="transform: scale(0.85);">
                                <input type="checkbox" id="notifyShareToggle" checked onchange="app.updateNotificationType('share')">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="shareTimingContainer">
                            <label style="font-size: 0.875rem; font-weight: 600; color: #10b981; display: block; margin-bottom: 0.5rem;">
                                Remind me:
                            </label>
                            <select class="form-select" id="shareNoticeSelect" onchange="app.updateNoticeTiming('share')" style="border-color: #10b981; background: white;">
                                <option value="10080">1 week before</option>
                                <option value="4320">3 days before</option>
                                <option value="1440" selected>1 day before</option>
                                <option value="720">12 hours before</option>
                                <option value="240">4 hours before</option>
                                <option value="60">1 hour before</option>
                                <option value="30">30 minutes before</option>
                                <option value="15">15 minutes before</option>
                            </select>
                        </div>
                    </div>

                    <!-- Test Notification -->
                    <button class="btn btn-primary" onclick="app.sendTestNotification()" style="width: 100%; margin-top: 0.5rem;">
                        Send Test Notification
                    </button>
                </div>

                <!-- Info Box -->
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem;">
                    <strong style="color: #92400e; font-size: 0.875rem;">How it works:</strong>
                    <ul style="margin-top: 0.5rem; margin-left: 1.25rem; font-size: 0.875rem; color: #92400e; line-height: 1.6;">
                        <li>Select your name from the list</li>
                        <li>Choose when you want to be reminded</li>
                        <li>We'll check every minute for upcoming duties</li>
                        <li>You'll get a browser notification + in-app banner</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Manage Members</div>
                <button class="close-btn" onclick="app.closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Add New Member</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="newMemberName" placeholder="Enter name..." onkeypress="if(event.key==='Enter')app.addMember()">
                        <button class="btn btn-primary" onclick="app.addMember()">Add</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Current Members (<span id="memberCount">0</span>)</label>
                    <div class="members-list" id="membersList"></div>
                </div>

                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button class="btn" onclick="app.clearData()" style="width: 100%; justify-content: center; background: var(--danger); color: white;">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Edit Modal -->
    <div class="modal" id="editWeekModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Week</div>
                <button class="close-btn" onclick="app.closeWeekEdit()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Food Prep</label>
                    <select class="form-select" id="editPrep"></select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sharing 
                        <span id="fixedShareWarning" style="font-size: 0.75rem; color: var(--warning); display: none;">
                            (Fixed rotation - edit disabled)
                        </span>
                    </label>
                    <select class="form-select" id="editShare"></select>
                </div>
                
                <div class="form-group" id="recalculateOption" style="display: none;">
                    <div class="toggle-switch" style="background: #fef3c7; border: 1px solid #f59e0b;">
                        <div>
                            <div class="toggle-label">Recalculate Future Weeks</div>
                            <div class="toggle-description">Automatically balance remaining weeks based on this change</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="recalcFuture" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="app.closeWeekEdit()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="app.saveWeekEdit()" style="flex: 2;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>